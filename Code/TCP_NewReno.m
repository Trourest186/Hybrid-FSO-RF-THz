clear all;
clc;

C=100*10^6;
RTT=100*10^(-3);
RTT0 = 25*10^-3;
alpha=0.4;
% beta=0.2; % Using for TCP Cubic
beta =0.9;
% C=100*10^6;
% RTT=100*10^(-3);
% alpha=0.4;
% beta=0.2;

N=100; %The total number of state of TCP CUBIC 
Da=1460;% bytes in one segment
W=C*RTT/(8*Da);

% tput=zeros(length(Pe),1);

% ph = RTT/RTT0;
C_0 =  5*10^-15 :5.9*10^-15:3*10^-13;
zenith = 10:1:50;
SNR = 15:1:40;
% SNR_thres = [6185	39.99996185	39.99996185	39.99996185	39.99996185	39.99996185	39.99996185	39.99996185	39.99996185	0.211296082	0.783653259	1.336479187	1.87046051	2.387123108	2.887840271	3.37451934822]';
% Pe = 0.0630;
% Pe =[0.346049336	0.24876467	0.210753843	0.16739237	0.123632076	0.084379549	0.053017684	0.03063917	0.016314616	0.008037641	0.003688569	0.001793184	0.00066107	0.000225237	7.10E-05	0.000166258	4.54E-05	1.16E-05	2.78E-06	6.28E-07	2.35E-07	2.35E-07	2.37E-07	8.34E-08	4.26E-11	7.24E-12	1.57E-11	3.31E-11	6.58E-11	1.22E-10	2.08E-10	3.23E-10	4.54E-10	5.78E-10	6.72E-10	7.28E-10	7.53E-10	7.61E-10	7.63E-10	7.64E-10	7.64E-10]';
% Pe =[0.998672642	0.998874582	0.998983371	0.99896448	0.998689905	0.997679153	0.993962995	0.979573748	0.929302581	0.79805668	0.571312786	0.321368685	0.140624844	0.049349526	0.014736281	0.004115426	0.001232397	0.000454035	0.000215973	0.000124191	7.82E-05	5.09E-05	3.41E-05	2.40E-05	1.82E-05	1.51E-05]';
Pe =[0.003621358	0.004207998	0.004841954	0.005522027	0.006246806	0.007014713	0.007824044	0.008673004	0.009559732	0.010482333	0.011438894	0.0124275	0.013446254	0.014493285	0.015566755	0.016664873	0.017785892	0.018928123	0.02008993	0.021269736	0.022466024	0.023677339	0.024902284	0.026139525	0.027387787	0.028645852	0.029912563	0.031186816	0.032467564	0.033753812	0.035044615	0.036339081	0.037636363	0.038935661	0.040236217	0.041537319	0.042838293	0.044138504	0.045437355	0.046734284	0.048028761	0.049320292	0.05060841	0.051892679	0.053172691	0.054448064	0.055718441	0.056983488	0.058242896	0.059496376	0.06074366]';
% lamda = zeros(length(Pe),1);
% mu=-8:0.1:0;
% Pe = zeros(length(mu),1);
% for l=1:1:length(mu)
%     Pe(l,1)=10^mu(l);
% end
lamda = zeros(length(Pe),1);
tput=zeros(length(Pe),1);
% C_cubic = ((4-beta)/4*RTT)*nthroot(beta/alpha,3);

% Pe = zeros(length(SNR),1);
%=======================================
% for l=1:1:length(mu)
%     Pe(l,1)=10^mu(l);
% end
% g = (8*ph^2)*(1-exp(-(Pe(k,1)*3*W^2)/(8*ph^2)));
for k=1:1:length(Pe)
%    Pe(k,1)= Pt_FSO_RF(k-1,SNR_thres(k,1));
   Wmax =sqrt(((8)*(1-exp(-(Pe(k,1)*3*W^2)/(8))))/(3*Pe(k,1)));
   lamda(k,1) = (2)/(RTT*Wmax);
%     if k ==16 
%         lamda(k,1) = 0.0400;
%     end
%         if k ==16
%             lamda(k,1) =0.08010230;
%         end
   T=zeros(N,N);
   S=zeros(N,N);
   A=zeros(N,N);
   B=zeros(N,1);
   F=zeros(N,1);
   F(N,1)=1;
%Stationary Distribution
   for i=1:N
        for j=1:N
            a=(i-0.5)*(W/N);
%             L=(((beta)*a)/(alpha))^(1/3);    
            t=max(0,((((j-1)*W/N)-beta*a))*RTT);
            T(i,j)=t;
            s=((t^2)/(2*RTT)) + beta*a*t;
            S(i,j)=s;
              if j < beta*(i-0.5)
                 p=0;
              else
                 p=exp(-lamda(k,1)*(max(0,RTT*((((j-1)*W/N)-beta*a)))))- exp(-lamda(k,1)*RTT*((((j)*W/N)-beta*a)));           
              end  
           A(i,j)=p;
         end
   end
   for g=1:N
    A(g,N)=1-sum(A(g,[1:N-1]));
   end
   A_p1=A;
   for z=1:N
    A(z,z)=A(z,z)-1;
   end
   H=A';
   for m=1:N
    H(N,m)=1;
   end
   B=inv(H)*F;
  %Throughput
   AW1=0;
   AT1=0;
   for i=1:N
       for j=1:N
        AW1=AW1+B(i,1)*A_p1(i,j)*S(i,j);
        AT1=AT1+B(i,1)*A_p1(i,j)*T(i,j);
       end
   end
   
        tput(k,1)=((1/W)*(AW1/AT1))*C; % Nhân với C nhớ

 
 tput(isnan(tput)) =0;
end
% tput(isnan(tput)) = 1;
semilogx(C_0,tput,'--');
hold on;
xlabel('SNR');
ylabel('Throughput');
grid on;

    

